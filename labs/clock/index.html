<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="">
<meta name="author" content="">

<title>
    
    Lab 4: Clock • ECEN 330
    
</title>

<!-- Bootstrap core CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

<!-- Custom styles for this template -->
<link rel="stylesheet" href=/ecen330/css/main.css>

<!-- <link href="https://fonts.googleapis.com/css?family=Ubuntu&display=swap" rel="stylesheet"> -->
<!-- <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono&display=swap" rel="stylesheet"> -->
<link rel="stylesheet" href="https://use.typekit.net/jcn6ybb.css">

<!-- <link rel="icon" type="image/png" sizes="96x96" href=/ecen330/icon/favicon-96x96.png>
<link rel="icon" type="image/png" sizes="32x32" href=/ecen330/icon/favicon-32x32.png>
<link rel="icon" type="image/png" sizes="16x16" href=/ecen330/icon/favicon-16x16.png> -->

<script src="https://kit.fontawesome.com/624d595ebf.js" crossorigin="anonymous"></script>

</head>

<body>
  <div class="d-flex" id="wrapper">
    <div class="border-right sidebar-color" id="sidebar-wrapper">
    <div class="sidebar-sticky">
        <div class="sidebar-heading-big">
            <a href="/ecen330/">
                ECEN 330</a>
        </div>
        <div class="list-group list-group-flush sidebar-color">

            

            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            
            <!-- <a href="https://slack.com/app_redirect?team=T01J887F8MU&channel=C01JF1N6TH8"
                class="list-item-normal list-group-item list-group-item-action sidebar-item" target="_blank"><i
                    class="fa fa-question-circle"></i>
                Slack</a> -->

        </div>

        <div class="sidebar-heading">Setup</div>
        <div class="list-group list-group-flush">
            
            <a href="/ecen330/setup/step-1/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Setup Step #1

            </a>
            
            <a href="/ecen330/setup/linux/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Home Setup: Linux

            </a>
            
            <a href="/ecen330/setup/vm/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                &emsp;

                Home Setup: VM

            </a>
            
            <a href="/ecen330/setup/step-2/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Setup Step #2

            </a>
            
        </div>

        <div class="sidebar-heading">Labs</div>
        <div class="list-group list-group-flush">
            
            <a href="/ecen330/labs/hello-world/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">1</span>
                Hello World

            </a>
            
            <a href="/ecen330/labs/switches-buttons/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">2</span>
                Switches/Buttons Driver

            </a>
            
            <a href="/ecen330/labs/timer/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">3</span>
                Timer Driver

            </a>
            
            <a href="/ecen330/labs/clock/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">4</span>
                Clock

            </a>
            
            <a href="/ecen330/labs/tictactoe/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">5</span>
                Tic Tac Toe

            </a>
            
            <a href="/ecen330/labs/simon/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">6</span>
                Simon

            </a>
            
            <a href="/ecen330/labs/project/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">7</span>
                Choose Your Own

            </a>
            
            <a href="/ecen330/labs/wam/"
                class="list-item-normal list-group-item list-group-item-action bg-light sidebar-item">
                <span class="badge badge-pill badge-dark-grey">7-alt</span>
                Whack-a-Mole

            </a>
            
        </div>

        <div class="sidebar-heading">Documentation</div>
        <div class="list-group list-group-flush">
            
            <a href="/ecen330/documentation/compiling/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Compiling and Running

            </a>
            
            <a href="/ecen330/documentation/cmake/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                CMake

            </a>
            
            <a href="/ecen330/documentation/headers/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Header Files

            </a>
            
            <a href="/ecen330/documentation/submission/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Submitting Code

            </a>
            
            <a href="/ecen330/documentation/vscode/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Coding/Debugging Tips

            </a>
            
        </div>

        <div class="sidebar-heading">Other</div>
        <div class="list-group list-group-flush">
            
            <a href="/ecen330/other/kr-study-questions/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                K&R Study Questions

            </a>
            
            <a href="/ecen330/other/coding-standard/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Coding Standard

            </a>
            
            <a href="/ecen330/other/coding-state-machines/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Coding State Machines

            </a>
            
            <a href="/ecen330/other/suggestions/"
                class="list-item-narrow list-group-item list-group-item-action bg-light sidebar-item">
                

                Suggestions

            </a>
            
        </div>
    </div>
</div>

    <!-- Page Content -->
    <div id="page-content-wrapper">

      <nav class="navbar sticky-top navbar-expand-lg border-bottom">
        <button class="btn btn-brand" id="menu-toggle">
          <i class="fas fa-bars"></i>
        </button>

        <a href="" class="navbar-brand mb-0 h1 page-title-bar text-center mx-auto" id="page-title-bar"></a>

        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link btn btn-brand suggest-edits" target="_blank" rel="noopener noreferrer"
              href="https://piazza.com/byu/spring2022/ecen330"><i class="far fa-question-circle"></i> Piazza</a>
          </li>

          <li class="nav-item">
            <a class="nav-link btn btn-brand suggest-edits" target="_blank" rel="noopener noreferrer"
              href="https://github.com/byu-cpe/ecen330/issues/new?labels=website&title=Updates to Lab 4: Clock page"><i
                class="fab fa-github"></i> Suggest
              Edits</a>
          </li>
        </ul>
      </nav>

      <div class="container">
        <article class="page lab">
    <h1 class="page-title" id="page-title">
        Lab 4: Clock
        
    </h1>

    <div class="page-content">
        
        <div class="lab-toc col-md-6 col-lg-5 bg-light">
            <h4>Table of Contents</h4>
            <ul>
  <li><a href="#overview">Overview</a></li>
  <li><a href="#objectives">Objectives</a></li>
  <li><a href="#preliminary">Preliminary</a>
    <ul>
      <li><a href="#building-this-lab">Building this Lab</a></li>
      <li><a href="#display-versus-control">Display versus Control</a>
        <ul>
          <li><a href="#display">Display</a></li>
          <li><a href="#control">Control</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#implementation">Implementation</a>
    <ul>
      <li><a href="#requirements">Requirements</a></li>
      <li><a href="#milestones">Milestones</a>
        <ul>
          <li><a href="#milestone-1">Milestone 1:</a></li>
          <li><a href="#milestone-2">Milestone 2:</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#submission--pass-off">Submission &amp; Pass Off</a>
    <ul>
      <li><a href="#grade-breakdown">Grade Breakdown</a></li>
    </ul>
  </li>
</ul>

        </div>
        

        <h2 id="overview">Overview</h2>

<p>In this lab you will implement a clock. Every modern device seems to include a clock, so we want one too. Your clock will look like this:</p>
<iframe width="560" height="315" allow="fullscreen" src="https://www.youtube.com/embed/s8tV_iznYRU"> </iframe>

<p>The middle numerical display shows the time in 12-hour format. The green triangles (arrows) above and below indicate touch regions above and below the clock display that allow you to set the time. The arrows that are above the display will increment the hours, minutes, and seconds of the clock, when touched. The arrows that are below the clock will decrement the hours, minutes, and seconds of the clock when touched. These clock-setting functions also have an auto-update rate that engages after the user presses the arrow for at least 0.5 seconds. Once the auto-update engages, it updates the time at a rate of 10 changes per second. For example, say the user presses the arrow below the minutes field for 0.5 seconds. After the initial 0.5 second delay, the hours will decrement automatically at a rate of 10 decrements per second. You have probably seen similar functionality in the clocks that you have used.</p>

<h2 id="objectives">Objectives</h2>

<ul>
  <li>Implement a synchronous state machine for the first time, and learn how to debug state machines.</li>
  <li>Use the interval timer package from the previous lab to measure execution time of your <em>tick</em> function.</li>
  <li>Learn how to identify and separate control and display functions.</li>
  <li>Use interrupts using the <em>flag method</em>: waiting for a flag set by the interrupt service routine before calling <em>clockControl_tick()</em>.</li>
</ul>

<h2 id="preliminary">Preliminary</h2>

<h3 id="building-this-lab">Building this Lab</h3>
<p>All of your code for this lab will be written in the <em>lab4</em> directory.  You will need to create a <em>CMakeLists.txt</em> file in this directory to build the clock application and link it to any necessary libraries.  You can mostly copy the <em>CMakeLists.txt</em> file from lab 2 or 3; however, you will have more .c files to compile than just <em>main.c</em>.</p>

<p>Modify the top-level <em>CMakeLists.txt</em> file to include your <em>lab4</em> folder.</p>

<!-- The clock application you build in this lab won't be reused in later labs, so you don't need to place any code in *drivers* or create any new libraries. -->

<h3 id="display-versus-control">Display versus Control</h3>

<p>The implementation of the lab will be separated into two major coding sections: display and control. This will provide good practice for just about any embedded-programming project as most embedded projects are usually best broken down this way, both for implementation and for debug/verification. We will follow this general strategy throughout the semester.</p>

<h4 id="display">Display</h4>

<p>The display code is responsible for <strong>storing the current clock value (hours, minutes, seconds), and rendering it on the display</strong>. This includes things like:</p>
<ul>
  <li>drawing the triangles that indicate the up/down touch regions that are used to set the current time.</li>
  <li>drawing the characters that indicate the time.</li>
  <li>incrementing and decrementing the seconds, minutes, and hours, when instructed to by the control code.</li>
  <li>updating the time when told that a second has passed.
Note that the display code has no “sense” of time. Its job is to perform computations and to draw things on the LCD but it has no sense of when these things should be done. The control code will tell the display code when it is time to add 1 second to the current time, when to update the screen when auto-update is occurring, etc.</li>
</ul>

<h4 id="control">Control</h4>

<p>The control code is responsible for <strong>knowing when the current time needs to change</strong>.  It does this by handling the up/down touch regions for setting the clock, and using a timer to know when 1 second has elapsed, and the time needs to increment. The control code controls when the display code does things. The control code has no “sense” of how the display is updated, it just controls when these updates occur. It does things like:</p>
<ul>
  <li>keep track of when it is time to add 1 second to the current time.</li>
  <li>when to increment or decrement the display according to the auto-update rate.</li>
  <li>it times how long the user presses a region on the display so it knows whether to invoke auto-update rate or not.</li>
  <li>keeps track of the settling time of the Analog-Digitial Converter (ADC) used by the controller chip that reads the resistive overlay on the LCD display.</li>
</ul>

<h2 id="implementation">Implementation</h2>

<p>This lab is comprised of several pieces that are described in further details on these pages:</p>

<ol>
  <li>Implementing <a href="/ecen330/clock-display/">clockDisplay.c</a>.</li>
  <li>Implementing <a href="/ecen330/clock-control/">clockControl.c</a>.</li>
  <li>Working with the <a href="/ecen330/touchscreen/">touch screen</a>.</li>
  <li>Making sure your code doesn’t miss interrupts (described in Milestone 2 below).</li>
</ol>

<h3 id="requirements">Requirements</h3>
<ul>
  <li>You must create files: <em>clockDisplay.c</em> and <em>clockControl.c</em>. The <em>clockDisplay</em> files contain the code that performs all of the updates to the LCD. The <em>clockControl</em> files contain the controlling state machine that performs all timing-related functions. You will implement clock control using a single synchronous state machine as discussed in Chapter 5 of the text.</li>
  <li><em>main.c</em> is given to you.</li>
  <li>The contents of the <em>.h</em> files are provided. Do not modify the <em>.h</em> code. Use it as given.</li>
  <li>You must use the <a href="/ecen330/other/coding-state-machines/">coding strategy/standard for state machines</a>, including writing a <em>debugStatePrint()</em> function.</li>
  <li>Ensure that you are not missing interrupts.</li>
  <li>You must implement the clockDisplay code such that it only draws the characters that need to be changed on the screen. Doing so will eliminate annoying flashing artifacts and make things run more smoothly. You cannot get full credit if the screen flashes or <strong>if the TAs determine (by code inspection) that you are drawing characters continuously even if they have not changed.</strong></li>
</ul>

<h3 id="milestones">Milestones</h3>

<p>You will complete this lab in two milestones.  You are provided a <a href="https://github.com/byu-cpe/ecen330_student/blob/master/lab4/main.c">main.c</a>.  Do not change it, except to uncomment one of the below lines to run the chosen milestone:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>////////////////////////////////////////////////////////////////////////////////
// Uncomment one of the following lines to run Milestone 1 or 2      ///////////
////////////////////////////////////////////////////////////////////////////////
// #define RUN_PROGRAM MILESTONE_1
// #define RUN_PROGRAM MILESTONE_2
</code></pre></div></div>

<h4 id="milestone-1">Milestone 1:</h4>
<ul>
  <li><em>clockDisplay.c</em>: You will completely implement the functionality for the display as described above. The text and arrow sizes must be updated when <em>CLOCKDISPLAY_TEXT_SIZE</em> is changed.  You must also implement the clockDisplay_runTest() routine described on the clockDisplay webpage.</li>
</ul>

<h4 id="milestone-2">Milestone 2:</h4>
<ul>
  <li><em>clockControl.c</em>: You will completely implement this file as described above.  Be sure that your clock works correctly and that the increment/decrement functions work for setting time.</li>
  <li>As a part of this milestone, you must follow the strategy discussed in <a href="/ecen330/other/coding-state-machines/">coding strategy/standard for state machines</a>  to print out each state as it is entered.  Be sure that the printed output matches the state-machine behavior from the provided state diagram.</li>
  <li>Use your intervalTimer from last lab to measure how long your <em>tick()</em> function takes in the worst case (when you need to draw all digits).  Make sure it runs in less than the timer period (<a href="https://github.com/byu-cpe/ecen330_student/blob/master/lab4/config.h">config.h</a> defines <code class="language-plaintext highlighter-rouge">#define CONFIG_TIMER_PERIOD 50.0E-3</code>).</li>
  <li>The provided main.c will run for 20 seconds, and then exit, reporting the number of interrupts that occurred and the number of interrupts serviced by your code.  Make sure you don’t miss more than 1 interrupt (which may happen at the start of your program, even if your tick is short).  If you are missing interrupts, your <em>tick()</em> function probably runs too slow.</li>
</ul>

<h2 id="submission--pass-off">Submission &amp; Pass Off</h2>
<p>Follow the <a href="/ecen330/documentation/submission/">instructions on submitting source code</a> to submit your code.</p>

<h3 id="grade-breakdown">Grade Breakdown</h3>
<ul>
  <li>30%: Milestone 1</li>
  <li>40%: Milestone 2
    <ul>
      <li>-10% overall, if your code does not print the debug state messages when run.</li>
      <li>-10% overall, if the isr invocation count differs from internal interrupt count by more than 1.</li>
      <li>-10% overall, if the clock is not very responsive, if it seems laggy, or if it flashes the display when updating the time.</li>
    </ul>
  </li>
  <li>30%: Code quality (adherence to coding standard).</li>
</ul>


    </div>
</article>
      </div>
    </div>
    <!-- /#page-content-wrapper -->

  </div>
  <!-- /#wrapper -->

  <!-- Bootstrap core JavaScript -->
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
    crossorigin="anonymous"></script>
<script src=/ecen330/js/jquery.visible.min.js></script>

<!-- Menu Toggle Script -->
<script>
    $("#menu-toggle").click(function (e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });

    var prevVisible = $('#page-title').visible();

    $(window).scroll(function () {
        currentVisible = $('#page-title').visible()
        if (prevVisible && !currentVisible) {
            console.log("Do something!");
            $("#page-title-bar").html($('#page-title').text());
        }

        if (!prevVisible && currentVisible) {
            $("#page-title-bar").html("")
        }

        prevVisible = currentVisible;
    });

</script>

</body>

</html>